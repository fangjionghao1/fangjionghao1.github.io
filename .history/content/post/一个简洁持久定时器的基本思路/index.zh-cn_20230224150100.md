---
title: 定时器
description: 简单定时器
date: 2023-02-24
slug: 工具
# image: Snipaste_2023-02-13_18-16-10.png
categories:
  - go
  - 工具开发
---

### 背景

系统中有一些定时任务。部署环境`windows2003r`,所以不能使用 linux 的 crontab 来做定时任务，另外就是编译成一个一个小工具，每次有新的定时任务就要做一个新的小工具。而且代码全封装，像是一个个 dll,如果有问题不好调试。
为此考虑制作一个定时任务调度的小系统。

### 思路

需要做的功能从底下到上层分别有
计时器:轮询计时任务列表，不断尝试拿出队头元素，检查是否到了 firetime，如果到了 firetime 执行相应的函数。
计时器离线功能：假如计时器始终在内存中，基本库都能实现这些功能。但是如果系统异常断电还要继续拉起未完成的定时任务，这时候就要考虑两个方向，一个是断线期间过期的任务怎么办，一个是怎么找到之前内存中的计时器。
所以要做持久。
持久的基本思路是：把计时器相关的内容放进数据库（入磁盘-可以不是数据库，文件一样可行）。计时器的相关内容包括，下一个执行时间和执行的函数，由于回调在内存中每次重启函数的内存位置都不好找所以换个思路就是用回调关键字来注册。熟悉微服务的朋友也许就感觉，这不是有点 etcd 的味道了。这样一来每次重启都能恢复计时器。
进一步既然要有回调函数，就要对回调函数进行管理
回调函数管理：包括回调的启停和注册注销
计时器的管理：单纯顺着的计时器并不好用，所以要加上

1. 找到上一个执行周期
2. 找下一个执行周期

所以持久的内容又要加上上一个执行计时器的时间。

到目前为止 计时器需要记录 关键字，下一个执行时间（或上一个（如果嫌麻烦可以两个都记录））

### 连载中。。。
